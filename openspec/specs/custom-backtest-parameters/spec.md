# custom-backtest-parameters Specification

## Purpose
TBD - created by archiving change add-custom-backtest-parameters. Update Purpose after archive.
## Requirements
### Requirement: 自定义网格参数编辑器
前端应用必须(SHALL)提供网格参数设置界面，允许用户手动配置网格策略参数和手续费参数。

#### Scenario: 面板默认展开显示
- **WHEN** 用户进入回测分析页面时
- **THEN** 网格参数设置面板默认展开显示
- **AND** 仅显示网格参数设置，不显示手续费相关参数
- **AND** 无需用户手动点击展开按钮

#### Scenario: 编辑手续费模式切换
- **WHEN** 用户点击面板右上角的"编辑手续费"按钮时
- **THEN** 切换到手续费编辑状态
- **AND** 隐藏网格参数显示界面
- **AND** 仅显示手续费相关参数的编辑界面（手续费率、最低收费、无风险利率、年交易日数）

#### Scenario: 编辑模式完成
- **WHEN** 用户在手续费编辑模式中点击保存或取消时
- **THEN** 返回网格参数显示模式
- **AND** 恢复网格参数的完整显示

#### Scenario: 统一面板显示
- **WHEN** 用户查看网格参数设置时
- **THEN** 显示标题为"网格参数设置"的统一面板
- **AND** 默认仅展示网格策略参数，不展示手续费相关参数

#### Scenario: 参数实时验证
- **WHEN** 用户修改参数值时
- **THEN** 立即验证参数的有效性
- **AND** 显示验证错误信息和建议修正值
- **AND** 验证适用于网格参数和手续费参数

#### Scenario: 参数范围验证
- **WHEN** 用户修改任何参数值时
- **THEN** 实时验证以下规则：
  - 价格区间比例：5%-100%
  - 投资金额：1000-1000万元
  - 网格步长不超过价格区间的50%
  - 单笔交易金额不超过总金额
  - 日期范围：30-120天
- **AND** 显示具体的验证错误信息
- **AND** 禁用保存按钮直到所有参数有效

#### Scenario: 参数应用和重测
- **WHEN** 用户点击"保存并重新回测"按钮时
- **THEN** 使用所有自定义参数重新执行回测分析
- **AND** 立即更新显示新的回测结果
- **AND** 参数包括网格参数和手续费参数

### Requirement: 网格策略参数支持
应用必须(SHALL)支持以下网格策略参数的自定义配置：

#### Scenario: 价格区间参数
- **WHEN** 用户配置价格上限和下限时
- **THEN** 参数值必须在合理范围内（下限 < 基准价 < 上限，上限/下限 < 2.0）
- **AND** 价格区间跨度在5%-200%之间

#### Scenario: 投资金额参数
- **WHEN** 用户配置投资金额时
- **THEN** 参数值必须在1000元-1000万元之间
- **AND** 金额必须是单笔数量的整数倍

#### Scenario: 基准价格参数
- **WHEN** 用户配置基准价格时
- **THEN** 参数值必须在价格区间内
- **AND** 基准价格影响网格的中心位置

#### Scenario: 网格步长参数
- **WHEN** 用户配置网格步长时
- **THEN** 参数值必须大于0且小于价格区间的一半
- **AND** 步长决定网格级别的密度

#### Scenario: 单笔数量参数
- **WHEN** 用户配置单笔交易数量时
- **THEN** 参数值必须为正整数
- **AND** 数量影响每次交易的规模

### Requirement: 时间区间参数支持
应用必须(SHALL)支持自定义回测时间区间的配置。

#### Scenario: 时间区间选择
- **WHEN** 用户选择自定义时间区间时
- **THEN** 提供日期范围选择器
- **AND** 限制在可用数据的时间范围内

#### Scenario: 时间区间验证
- **WHEN** 用户设置时间区间时
- **THEN** 验证起始日期早于结束日期
- **AND** 确保时间跨度至少30个交易日
- **AND** 时间跨度不超过120天

### Requirement: 后端参数验证和处理
后端必须(SHALL)验证和处理自定义网格参数。

#### Scenario: API参数接收
- **WHEN** 后端接收包含自定义参数的回测请求时
- **THEN** 解析并验证所有自定义参数
- **AND** 在参数无效时返回详细错误信息

#### Scenario: 网格策略构建
- **WHEN** 自定义参数有效时
- **THEN** 使用自定义参数构建网格策略配置
- **AND** 覆盖自动计算的参数值

#### Scenario: 回测执行
- **WHEN** 网格策略构建完成时
- **THEN** 使用自定义策略执行回测分析
- **AND** 返回包含自定义参数的完整结果

### Requirement: 参数持久化和恢复
应用必须(SHALL)支持所有自定义参数的会话级持久化，包括网格参数和手续费参数。

#### Scenario: 统一参数缓存
- **WHEN** 用户设置任何自定义参数时
- **THEN** 将所有参数存储在会话存储中
- **AND** 使用分析特定的缓存键包含所有参数类型

#### Scenario: 统一参数恢复
- **WHEN** 用户重新访问分析页面时
- **THEN** 从缓存中恢复上次使用的所有自定义参数
- **AND** 在参数无效时回退到默认参数

### Requirement: 错误处理和用户反馈
应用必须(SHALL)提供完善的错误处理和用户反馈机制。

#### Scenario: 参数验证错误
- **WHEN** 参数验证失败时
- **THEN** 显示具体的错误信息
- **AND** 提供参数修正建议
- **AND** 阻止无效参数的提交

#### Scenario: 回测执行错误
- **WHEN** 回测执行失败时
- **THEN** 显示友好的错误信息
- **AND** 提供重试选项
- **AND** 在必要时回退到自动参数

### Requirement: 性能优化
应用必须(SHALL)优化自定义参数功能的性能表现。

#### Scenario: 结果缓存
- **WHEN** 使用相同参数重复执行回测时
- **THEN** 返回缓存的结果
- **AND** 避免重复计算

#### Scenario: 增量验证
- **WHEN** 用户逐步修改参数时
- **THEN** 只验证变更的参数
- **AND** 提供即时反馈

### Requirement: 向后兼容性
应用必须(SHALL)保持与现有功能的完全兼容性。

#### Scenario: 默认行为保持
- **WHEN** 不使用自定义参数时
- **THEN** 行为与之前完全相同
- **AND** 自动参数计算不受影响

#### Scenario: API兼容性
- **WHEN** 客户端不发送自定义参数时
- **THEN** 后端使用自动计算的参数
- **AND** API响应格式保持不变

### Requirement: 手续费参数编辑支持
应用必须(SHALL)支持手续费相关参数的编辑和配置。

#### Scenario: 手续费率配置
- **WHEN** 用户编辑手续费率时
- **THEN** 支持0.001%-10%范围内的配置
- **AND** 默认值为0.02%

#### Scenario: 最低收费配置
- **WHEN** 用户编辑最低收费时
- **THEN** 支持1-100元范围内的配置
- **AND** 默认值为5元

#### Scenario: 无风险利率配置
- **WHEN** 用户编辑无风险利率时
- **THEN** 支持0.01%-20%范围内的配置
- **AND** 默认值为3%

#### Scenario: 年交易日数配置
- **WHEN** 用户编辑年交易日数时
- **THEN** 支持200-300天范围内的配置
- **AND** 默认值为244天

